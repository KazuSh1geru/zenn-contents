---
title: "エージェントノードの使い方を解説"
emoji: "😸"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["AiLabel", "agent", "AI"]
published: true
---

## はじめに

「エージェント＝if/loop だけ？」を一歩進める視点を持っていきたく、AIと壁打ちしました.
そのまとめ内容が納得感があったので記事として出力します.

### 背景

特にn8nやDifyのようなローコードツールにおいて、エージェントノードがサポートされています。従来のif文やループ文を使った単純な分岐処理に対し、エージェントノードはLLMの信頼度スコアを活用して、より高度な自動化や人手の介入（HITL）を柔軟に使い分ける仕組みを実現します。

### 課題感

「AIエージェントってどう使えばいいのか？」という疑問が多く、実際にエージェントノードの使い方を正しく把握していないと、その潜在能力が十分に活かされません。この記事では、エージェントノードの使い方を明確に解説し、信頼度スコアを基にした分岐処理の重要性とその運用方法について分かりやすく説明します。



## 1. そもそもエージェントノードが担う役割

| 視点 | 具体例 | 典型ノード構成 (Dify / n8n) |
| --- | --- | --- |
| ツールの呼び出しハブ | 例：メール内容を解析 → カレンダー API で予定登録 | Dify Agent ノード＋Tool list / n8n OpenAI / HTTP / Google 系ノード |
| 推論ステップの調停 | ReAct で「検索→要約→判断」を何度も回す | Dify Agent (ReAct) / n8n Sub-workflow でループ |
| 自動⇔人手のスイッチ | 信頼度 < 0.7 なら Slack にメンション | 条件分岐 + HITL (Slack, Gmail 等) |

Dify では「Function Calling / ReAct」を選ぶだけで LLM が 動的にツールを選択・実行できます。設定パネルでモデル・ツール・最大ステップなどを定義し、下流で条件分岐やループに渡せる構造化出力を得られます。

【信頼度スコアの計算と運用上のポイント】

エージェントノードは、LLMが出力する信頼度スコアを用いて、処理の自動化と人間確認のバランスを取ります。例えば、スコアが0.7未満の場合は自動処理を停止し、人間の介入（HITL）を促す仕組みが一般的です。具体的な計算例としては、LLMに1〜100の数値を返すよう指示し、その数値を0〜1に正規化して信頼度とする方法がよく用いられます。

また、実際の運用では処理ごとにログを取得し、経験的に閾値を調整することで、より精度の高い判断が可能となります。

⸻

## 2. "if / loop" の外にある 5 つの定番パターン

| パターン | 使いどころ | 実装ヒント |
| --- | --- | --- |
| ルーティング (Routing) | 問い合わせ分類 → 担当部署に振り分け | まず Agent で category を出力 → 条件分岐 |
| プロンプトチェイニング | 「要約→翻訳→フォーマット」など段階処理 | Dify なら各ステップを別ノード、n8n なら Sub-workflow |
| 並列化 / 投票 | 複数案を生成しベストを選ぶ | SplitInBatches → Agent → Merge & 評価 |
| オーケストレータ-ワーカー | 複雑タスクをサブタスクに分割 | 上位 Agent がタスク分解、下位 Agent が実行 |
| Evaluator-Optimizer (自己評価ループ) | コード生成や契約書レビューの品質を自動向上 | 出力 + "self_score" を返し、閾値未満なら再生成 |

これらは「LLM エージェントのワークフローパターン」で詳しく整理されています。 ￼

⸻

## 3. 信頼度スコアをどう作るか？

| 手法 | メリット | 実装例 |
| --- | --- | --- |
| LLM に自己採点させる「1〜100 で回答信頼度を数字だけ返せ」 | 追加 API 不要／プロンプトだけで導入可 | score を JSON で返して条件分岐 |
| 二段階 LLM 評価 Evaluator-Optimizer パターン | 主モデルのバイアス低減 | Agent(A) → Agent(B) がレビュー |
| 専用分類モデル／外部 API | 数値的に安定 | VertexAI / Bedrock の分類モデル等 |

点数化したあとは 条件分岐ノードで
score ≥ 0.8 → 自動実行 ／ score < 0.8 → Slack メンション といった HITL に繋げます。

n8n の実例（メール処理＋Slack 承認）も参考になります。 ￼

⸻

## 4. ガードレール & 運用のコツ

| 項目 | 具体策 |
| --- | --- |
| 安全性 | ・"システムプロンプト"に禁止事項を明示・実行前後で Regex フィルタや JSON スキーマ検証 |
| 観測性 | Dify のエージェント実行ログでステップとトークンを確認し、失敗例をリプレイする |
| コスト管理 | 再帰ループの最大ステップ数／並列数を制限 |
| 段階的自動化 | ① 全件 HITL → ② 信頼度高いサブセットのみ自動 → ③ 例外のみ HITL … と段階を踏む |

⸻

## 5. 何から始める？

タスクを絞る
  - 「ルールが明確」「成功判定が測定しやすい」もの（例：請求書OCR→金額抽出）から始める
最小フローを作る
  - Agent→条件分岐→Slack通知だけでもOK
信頼度ログを貯める
  - 手動で振り返り、閾値を調整
Toolを増やす／マルチパターン化
  - Function Callingで外部APIを関数化→ReActで複数ツールを動的選択
⸻

## 6. まとめ

これで「AI エージェントってどう使う？」という問いの解像度が一段上がるはずです。ぜひ手元のワークフローで試してみてください！
